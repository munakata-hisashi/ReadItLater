# 自動タイトル取得機能実装計画

## 概要
URLを保存する際にタイトル入力がない場合、LinkPresentationフレームワークを使用してWebページのタイトルを自動取得し、ブックマークのタイトルとして設定する機能を実装する。

## 実装方針

### 1. LinkPresentationフレームワークの統合
- iOS 13+で利用可能な`LinkPresentation`フレームワークを使用
- `LPMetadataProvider`を利用してURL先のメタデータ（タイトル、説明、画像など）を取得
- Apple推奨のアプローチで実装

### 2. アーキテクチャ設計

#### URLMetadataService
- **責務**: URLからメタデータを取得する単一責任のサービスクラス
- **場所**: `ReadItLater/Infrastructure/URLMetadataService.swift`
- **機能**:
  - `LPMetadataProvider`をラップ
  - 非同期でメタデータ取得
  - エラーハンドリング
  - タイムアウト制御

#### AddBookmarkViewModelの拡張
- **既存機能**: URL入力、タイトル入力、バリデーション
- **追加機能**:
  - URL入力時の自動メタデータ取得
  - ローディング状態管理
  - タイトル自動補完制御

#### UIの改善
- **AddBookmarkSheet**:
  - メタデータ取得中のローディング表示
  - 自動取得されたタイトルの表示
  - ユーザーによる手動編集の許可

### 3. 実装詳細

#### 3.1 URLMetadataService実装
```swift
// Infrastructure層に配置
class URLMetadataService {
    func fetchMetadata(for url: URL) async throws -> URLMetadata
    // タイムアウト、エラーハンドリング含む
}

struct URLMetadata {
    let title: String?
    let description: String?
    // 将来の拡張用
}
```

#### 3.2 AddBookmarkViewModelの機能追加
- `isFetchingMetadata: Bool` - メタデータ取得状態
- `fetchedTitle: String?` - 自動取得されたタイトル
- `shouldFetchMetadata: Bool` - メタデータ取得の制御フラグ
- URL変更時の自動メタデータ取得ロジック

#### 3.3 UIの改善
- タイトルフィールドのプレースホルダー動的変更
- メタデータ取得中のプログレスインジケーター
- 取得済みタイトルの明示的表示

### 4. ユーザー体験の考慮

#### 4.1 非同期処理の最適化
- URL入力後の適切なタイミングでメタデータ取得
- デバウンス処理でAPI呼び出し頻度制限
- キャンセレーション対応

#### 4.2 エラーハンドリング
- ネットワークエラー時のグレースフルな処理
- タイムアウト時のフォールバック
- 不正なURLの適切な処理

#### 4.3 ユーザビリティ
- 手動タイトル入力時の自動取得無効化
- 取得されたタイトルの編集可能性
- 設定によるメタデータ取得の無効化オプション（将来）

### 5. 実装順序

1. **LinkPresentationフレームワーク追加**
   - Xcodeプロジェクトへのフレームワーク追加

2. **URLMetadataService作成**
   - Infrastructure層にサービスクラス実装
   - 単体テスト作成

3. **AddBookmarkViewModel拡張**
   - メタデータ取得機能の統合
   - 状態管理の改善
   - ViewModelテストの更新

4. **UI改善**
   - AddBookmarkSheetの更新
   - ローディング状態表示
   - UIテストの更新

5. **統合テスト**
   - エンドツーエンドの動作確認
   - エラーケースの検証

### 6. テスト戦略

#### 6.1 単体テスト
- URLMetadataServiceの機能テスト
- AddBookmarkViewModelの拡張機能テスト
- エラーケースの網羅

#### 6.2 UIテスト
- メタデータ取得フローのUIテスト
- ローディング状態の確認
- ユーザー操作の検証

### 7. パフォーマンス考慮

#### 7.1 メモリ管理
- LPMetadataProviderの適切なライフサイクル管理
- メタデータのキャッシュ戦略（将来）

#### 7.2 ネットワーク効率
- 適切なタイムアウト設定
- 不要なリクエストの回避
- デバウンス処理の実装

### 8. 将来の拡張可能性

#### 8.1 機能拡張
- メタデータキャッシュ機能
- 画像プレビュー表示
- 説明文の自動取得

#### 8.2 設定オプション
- メタデータ取得の有効/無効切り替え
- タイムアウト時間の設定
- プライバシー関連の設定

## 実装完了条件

1. URL入力時にタイトルが空の場合、自動でWebページタイトルを取得
2. メタデータ取得中のローディング状態が適切に表示される
3. 取得エラー時のグレースフルな処理
4. 既存機能に影響を与えない
5. 全テストが通過する
6. ビルドが成功する

## リスク分析

### 技術的リスク
- **ネットワーク依存**: オフライン時の適切な処理
- **パフォーマンス**: メタデータ取得の遅延
- **プライバシー**: 外部サイトへのアクセス

### 軽減策
- タイムアウト設定とエラーハンドリング
- ユーザーへの適切なフィードバック
- 設定による機能無効化オプション（将来）